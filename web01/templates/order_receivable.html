{% extends 'layout.html' %}

{% block content %}

    <div>
        <div class="container mt-5">

            <div>
                <div class="card">
                    <div class="d-flex justify-content-between align-items-center" style="padding: 10px;">
                        <div style="width: 200px">
                            <h2 class="mt-2 " style="margin-left: 10px;">è®¢å•åº”æ”¶</h2>
                        </div>

                    </div>

                    <div class="card-body">
                        <table class="table table-bordered mt-3">
                            <thead>
                            <tr>
                                <th scope="col">è®¢å•å·</th>
                                <th scope="col">å•†å“å</th>
                                <th scope="col">æ•°é‡</th>
                                <th scope="col">åº”æ”¶</th>
                                <th scope="col">å·²æ”¶</th>
                                <th scope="col">æ“ä½œ</th>

                            </tr>
                            </thead>
                            <tbody>
                            {% for item in queryset %}

                                <tr>

                                    <th scope="row">{{ item.oid }}</th>
                                    <td> {{ item.product }}</td>
                                    <td> {{ item.quantity }}</td>
                                    <td> {{ item.total_price }}</td>
                                    <td> {{ item.paid }}</td>


                                    <td>
                                        <input uid="{{ item.id }}" type="button" class="btn btn-primary btn-xs btn-edit"
                                               href="" value="ğŸ’µæ”¶æ¬¾">



                                    </td>


                                </tr>
                            {% endfor %}

                            </tbody>
                        </table>


                    </div>

                    <ul class="pagination mt-2">
                        {{ page_string }}
                    </ul>
                </div>
            </div>


            {#æ¨¡æ€æ¡†#}
            <div class="modal fade" id="myModel" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="myModalLabel">æ”¶æ¬¾</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">

                            <form id="formAdd">
                                <div class="row">
                                    {% for field in form_p %}
                                        <div class="col-xs-6 col-md-6">
                                            <div class="form-group " style="position: relative">
                                                <label>{{ field.label }}:</label>
                                                {{ field }}
                                                <span class="error-msg"
                                                      style="color: red;position: absolute">{{ field.errors.0 }}</span>


                                            </div>
                                        </div>
                                    {% endfor %}
                                    <label>
                                        æ”¶æ¬¾é‡‘é¢
                                        <input type="text" name="new_paid" class="form-control " >
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å– æ¶ˆ</button>
                            <button id="btnSave" type="button" class="btn btn-primary">ä¿ å­˜</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>






    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="alert alert-danger" role="alert">
                    <h3> A simple danger alertâ€”check it out!</h3>

                    <p style="text-align: right">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å– æ¶ˆ</button>
                        <button id='btnConfirmDelete' type="button" class="btn btn-primary">ä¿ å­˜</button>
                    </p>
                </div>

            </div>
        </div>
    </div>


{% endblock %}


{% block js %}

    <script>

        var DELETE_ID;
        var EDIT_ID;


        $(function () {
            bindBtnAddEvent();
            bindBtnSaveEvent();
            bindBtnDeleteEvent();
            bindBtnConfirmDeleteEvent();
            bindBtnEditEvent();

        })

        function bindBtnAddEvent() {
            $('#btnAdd').click(function () {

                EDIT_ID = null;
                //æ¸…ç©ºè¡¨å•
                $('#formAdd')[0].reset();


                $('#myModel').modal('show');
            })
        }

        function bindBtnSaveEvent() {
            $("#btnSave").click(function () {

                //æ¸…é™¤é”™è¯¯ä¿¡æ¯
                $(".error-msg").empty();

                if (EDIT_ID) {
                    //ç¼–è¾‘
                    doEdit();

                } else {
                    //æ–°å»º
                    doAdd();
                }


            });
        }

        function doAdd() {
            $.ajax({
                url: '/company/add/',
                type: 'post',
                data: $("#formAdd").serialize(),
                dataType: 'JSON',
                success: function (res) {
                    if (res.status) {
                        alert('æ·»åŠ æˆåŠŸ');
                        //æ¸…ç©ºè¡¨å•
                        $('#formAdd')[0].reset();
                        //å…³é—­å¯¹è¯æ¡†
                        $('#myModel').modal('hide');
                        //åˆ·æ–°é¡µé¢
                        location.reload();

                    } else {
                        $.each(res.error, function (name, erroList) {
                            $("#id_" + name).next().text(erroList[0]);
                        })
                    }
                }
            })
        }

        function doEdit() {
            $.ajax({
                url: '/order/payment/?uid=' + EDIT_ID,
                type: 'post',
                data: $("#formAdd").serialize(),
                dataType: 'JSON',
                success: function (data) {
                    if (data.status) {
                        alert('æäº¤æˆåŠŸ');
                        //æ¸…ç©ºè¡¨å•
                        //$("#formAdd")æ˜¯jQueryå¯¹è±¡ï¼Œ -> $("#formAdd")[0]æ˜¯åŸç”ŸDOMå¯¹è±¡
                        $("#formAdd")[0].reset();
                        //å…³é—­å¯¹è¯æ¡†
                        $('#myModal').modal('hide');
                        //åˆ·æ–°é¡µé¢
                        location.reload();

                    } else {
                        if (data.tips) {
                            alert(data.tips);
                        }
                        //æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        $.each(data.error, function (name, erroList) {
                            $("#id_" + name).next().html(erroList[0]);
                        })
                    }

                    console.log(data);

                    {#//æäº¤æˆåŠŸåï¼Œå…³é—­å¯¹è¯æ¡†#}
                    {#$('#myModal').modal('hide');#}
                    {#//åˆ·æ–°é¡µé¢#}
                    {#location.reload();#}
                }
            })
        }

        function bindBtnDeleteEvent() {
            //ç»™åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
            $(".btn-delete").click(function () {
                //æ˜¾ç¤ºåˆ é™¤å¯¹è¯æ¡†
                $('#deleteModal').modal('show');

                //è·å–è¦åˆ é™¤çš„IDèµ‹å€¼ç»™å…¨å±€å˜é‡
                DELETE_ID = DELETE_ID = $(this).attr("uid");


            });
        }

        function bindBtnConfirmDeleteEvent() {
            //ç»™ç¡®è®¤åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶
            $("#btnConfirmDelete").click(function () {
                console.log("æµ‹è¯•")
                //ç‚¹å‡»ç¡®è®¤åˆ é™¤æŒ‰é’®åï¼Œæäº¤åˆ é™¤è¯·æ±‚
                $.ajax({
                    url: '/company/delete/',
                    type: 'GET',
                    data: {uid: DELETE_ID},
                    dataType: 'JSON',
                    success: function (data) {
                        if (data.status) {
                            alert('åˆ é™¤æˆåŠŸ');
                            //å…³é—­å¯¹è¯æ¡†
                            $('#deleteModal').modal('hide');
                            //åˆ é™¤é¡µé¢ä¸­çš„æ•°æ®
                            $("tr[uid=" + DELETE_ID + "]").remove();
                        } else {
                            alert('åˆ é™¤å¤±è´¥');
                        }
                    }
                })
            });
        }

        function bindBtnEditEvent() {
            $(".btn-edit").click(function () {
                //æ¸…ç©ºè¡¨å•
                $("#formAdd")[0].reset();
                EDIT_ID = $(this).attr("uid");


                //å‘é€ajaxå»åå°è·å–å½“å‰è¡Œæ•°æ®
                $.ajax({
                    url: '/order/rec/detail/',
                    type: 'GET',
                    data: {uid: $(this).attr("uid")},
                    dataType: 'JSON',
                    success: function (data) {
                        //å°†æ•°æ®èµ‹å€¼åˆ°æ ‡ç­¾
                        $.each(data.data, function (name, value) {
                            $("#id_" + name).val(value);
                        })


                        //ä¿®æ”¹å¯¹è¯æ¡†çš„æ ‡é¢˜
                        $("#myModalLabel").text("æ”¶æ¬¾ä¿¡æ¯");

                        //ç‚¹å‡»ç¼–è¾‘æ˜¾ç¤ºæ¨¡æ€æ¡†
                        $('#myModel').modal('show');
                    }
                })

                //åœ¨å¯¹è¯æ¡†æ˜¾ç¤º

            });
        }

    </script>

{% endblock %}